<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>匿名聊天室</title>
</head>
<body>
    <div id="chat" style="height:400px; overflow-y:scroll; border:1px solid #ccc;"></div>
    <input type="text" id="message" style="width:300px;">
    <button onclick="sendMessage()">发送</button>

    <script>
        const ws = new WebSocket('ws://localhost:8765');
        const chatDiv = document.getElementById('chat');
        
        // 接收消息
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const msgElement = document.createElement('div');
            
            if(data.type === 'system') {
                msgElement.innerHTML = `<span style="color:gray">${data.content}</span>`;
                if(data.history) {
                    data.history.forEach(msg => renderMessage(msg));
                }
            } else {
                renderMessage(data);
            }
            chatDiv.appendChild(msgElement);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        };

        function renderMessage(msg) {
            const element = document.createElement('div');
            element.innerHTML = `
                [${msg.time}] <b>${msg.user}</b>: ${msg.content}
            `;
            return element;
        }

        function sendMessage() {
            const input = document.getElementById('message');
            ws.send(input.value);
            input.value = '';
        }
    </script>
</body>
</html>
