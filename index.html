<!DOCTYPE html>
<html>
<head>
    <title>匿名聊天室</title>
    <style>
        #chat { height: 400px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; }
        .message { margin: 5px 0; padding: 5px; background: #f0f0f0; }
        .file { color: blue; cursor: pointer; }
    </style>
</head>
<body>
    <div id="chat"></div>
    <input type="text" id="input" placeholder="输入消息">
    <input type="file" id="fileInput">
    <button onclick="sendMessage()">发送</button>
    <button onclick="loadHistory()">加载历史</button>

    <script>
        const ws = new WebSocket('ws://mc.potatoblock.top:8765')
        
        // 消息接收处理
        ws.onmessage = async (event) => {
            const msg = JSON.parse(event.data)
            const div = document.createElement('div')
            div.className = 'message'
            
            switch(msg.type) {
                case 'text':
                    div.innerHTML = `${msg.timestamp}<br>${msg.content}`
                    break
                case 'file':
                    div.innerHTML = `${msg.timestamp}<br>
                        <a class="file" href="${msg.content.url}" download>下载文件: ${msg.content.name}</a>`
                    break
                case 'history_response':
                    msg.content.forEach(m => {
                        const item = document.createElement('div')
                        item.innerHTML = `${m.timestamp} - ${JSON.parse(m.content)}`
                        document.getElementById('chat').appendChild(item)
                    })
                    return
                case 'system':
                    div.style.color = 'green'
                    div.textContent = msg.content
            }
            document.getElementById('chat').appendChild(div)
            document.getElementById('chat').scrollTop = 999999
        }

        // 发送文本消息
        function sendMessage() {
            const input = document.getElementById('input')
            ws.send(JSON.stringify({
                type: 'text',
                content: input.value,
                timestamp: new Date().toISOString()
            }))
            input.value = ''
        }

        // 发送文件
        document.getElementById('fileInput').onchange = function() {
            const file = this.files
            const reader = new FileReader()
            reader.onload = () => {
                const base64 = reader.result.split(',')‌:ml-citation{ref="5" data="citationList"}
                ws.send(JSON.stringify({
                    type: 'file',
                    content: {
                        name: file.name,
                        data: base64  // 发送Base64编码
                    },
                    timestamp: new Date().toISOString()
                }))
            }
            reader.readAsDataURL(file)
        }

        // 加载历史
        function loadHistory() {
            ws.send(JSON.stringify({
                type: 'history_request',
                content: { limit: 50 },
                timestamp: new Date().toISOString()
            }))
        }
    </script>
</body>
</html>
